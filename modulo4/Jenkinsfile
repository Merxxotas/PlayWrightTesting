pipeline {
    // 1. Agente de Ejecución
    agent {
        docker {
            image 'node:22'
            args '-u root:root'
        }
    }

    stages {
        // 2. Etapa de Configuración del Entorno
        stage('Setup Environment') {
            steps {
                script {
                    try {
                        sh 'apt-get update && apt-get install -y python3 python3-pip curl'
                        sh 'python3 --version'
                        sh 'pip --version'
                    } catch (Exception e) {
                        error "Error setting up the environment: ${e.getMessage()}"
                    }
                }
            }
        }

        // 3. Etapa de Instalación de Dependencias
        stage('Install Dependencies') {
            parallel {
                stage('Module 1 - JS Deps') {
                    steps {
                        dir('modulo1') {
                            sh 'npm install'
                        }
                    }
                }
                stage('Module 2 - JS Deps') {
                    steps {
                        dir('modulo2') {
                            sh 'npm install'
                        }
                    }
                }
                stage('Module 3 - JS Deps') {
                    steps {
                        dir('modulo3') {
                            sh 'npm install'
                        }
                    }
                }
                stage('Module 4 - Python Deps') {
                    steps {
                        dir('modulo4') {
                            // Solución para el error PEP 668
                            sh "pip install -r requirements.txt --break-system-packages"
                        }
                    }
                }
            }
        }

        // Instalar Navegadores de Playwright
        stage('Install Playwright Browsers') {
            steps {
                dir('modulo3') {
                    sh 'npx playwright install --with-deps'
                }
            }
        }

        // 4. Etapa para Iniciar Servidores
        stage('Start Servers') {
            parallel {
                stage('Start HTTP Server') {
                    steps {
                        sh 'npm install -g http-server'
                        sh 'nohup http-server -p 5500 > http-server.log 2>&1 & echo $! > http-server.pid'
                        echo "HTTP Server starting..."
                    }
                }
                stage('Start Flask API Server') {
                    steps {
                        dir('modulo4') {
                            sh 'nohup python3 app.py > ../flask-api.log 2>&1 & echo $! > ../flask-api.pid'
                            echo "Flask API Server starting..."
                        }
                    }
                }
            }
        }

        // 5. Etapa para Esperar que los Servidores estén listos
        stage('Wait for Servers') {
            parallel {
                stage('Wait for HTTP Server') {
                    steps {
                        timeout(time: 2, unit: 'MINUTES') {
                            sh 'while ! curl -s http://127.0.0.1:5500; do echo "Waiting for HTTP server..."; sleep 2; done'
                            echo "HTTP Server is ready!"
                        }
                    }
                }
                stage('Wait for Flask API Server') {
                    steps {
                        timeout(time: 2, unit: 'MINUTES') {
                            sh 'while ! curl -s http://127.0.0.1:5000/resources; do echo "Waiting for Flask API server..."; sleep 2; done'
                            echo "Flask API Server is ready!"
                        }
                    }
                }
            }
        }

        // 6. Etapa de Ejecución de Pruebas
        stage('Run Tests') {
            parallel {
                stage('Run Playwright Tests - Module 1') {
                    steps {
                        dir('modulo1') {
                            sh 'npx playwright test'
                        }
                    }
                }
                stage('Run Playwright Tests - Module 2') {
                    steps {
                        dir('modulo2') {
                            sh 'npx playwright test --grep-invert "visual"'
                        }
                    }
                }
                stage('Run Playwright Tests - Module 3') {
                    steps {
                        dir('modulo3') {
                            sh 'npx playwright test --grep-invert "visual"'
                        }
                    }
                }
                stage('Run Pytest API Tests - Module 4') {
                    steps {
                        dir('modulo4') {
                            sh 'pytest tests/module4-api_tests.py'
                        }
                    }
                }
            }
        }
    }

    // 7. Etapa Posterior a la Ejecución
    post {
        always {
            script {
                // Detener ambos servidores
                sh '''
                    if [ -f http-server.pid ]; then
                        echo "Stopping HTTP Server..."
                        kill $(cat http-server.pid) || true
                        rm http-server.pid
                    fi
                    if [ -f flask-api.pid ]; then
                        echo "Stopping Flask API Server..."
                        kill $(cat flask-api.pid) || true
                        rm flask-api.pid
                    fi
                '''
            }
            // Limpiar el espacio de trabajo
            cleanWs()
        }
    }
}